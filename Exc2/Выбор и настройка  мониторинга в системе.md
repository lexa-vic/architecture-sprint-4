## Мотивация

Мониторинг это неотъемлимая часть любой системы обеспечивающая ее наблюдаемость. Благодаря этому мы :
- имеем представление как работает система, что идет хорошо, а что не очень, повышаем стабильность системы
- можем быстрее реагировать на падения и инциденты
- можем быстрее определить деградацию и узкие места в системе, до того как это почувствует пользователь
- можем реализовать бизнес метрики и на основе них получить ценные бизнес-инсайты

## Выбор подхода и метрик

### Shop API
Для это части можно выбрать метод "Четыре золотых сигнала", при это нам потребуются следующие метрики:

**Задержка**
  - Response time (latency) for shop API - время ответов от АПИ

**Трафик**
  - Number of requests (RPS) for internet shop API - метрик о кол-ве запросов это база, котора говорит о нагрузке
  - Number of requests (RPS) per user for internet shop API - меткрика кол-ва запросов на каждого юзера, нам может понадобиться для выявлении аномалий, каких-то выбрасов, так же для понимания небходимости кэширования, если мы увидим множетво однотипных запросов
  - Kb tranferred (received) for shop API
  - Kb provided (sent) for shop API 
  Трафик важнейшая метрика, которая: 
  1. Показывает эффективность обслуживания сервисом запросов

    Например:
    1. Если трафик большой, а кол-во запросов мало, то это говорит об неоптимальности ответов, избыточности. Возможно это говорит о необходимости оптимизаций: сжатия, клиентского кэширования
    2. Кейс когда кол-во запросов увеличивается например в 3 раза, а трафик в 10. Что-то может быть не так, например не работают CDN, а все отдаем через API сервиса.
   2. Показывает возникновение проблем с производительностью. Например резко вырос трафик, а кол-во запросов почти такое же, может означать, что кто-то добавил не эффектиный метод или клиенты стали по другому работать.
   3. Частично показывает еще и стоимость инфраструктуры, т.к. при увеличени трафика растет и стоимость хранния/обслуживания и всей системы.
   4. С помощью ней можем прогназировать необходимость масштабирования.
 

**Ошибки**
Тут мы собираем метрки по ошибкам от сервиса. 

 - Number of HTTP 200 for shop API - тут можно настроить чтобы система мониторила ответы с 200, но с неправильными ответами/неверным контентом (проверяем неявные ошибки)
 - Number of HTTP 500 for shop API - кол-во внутренних ошибок сервера

**Насыщенность**
Эти параметры показывают насколько наполненна наша система. Важно понимать когда возникают ошибки, когда у нас система на пределе или когда не нагружена.

  - CPU % for shop API - утилизация CPU для сервиса
  - Memory Utilisation for shop API - утилизация по памяти для сервиса
     
     
### MES API
Для это части так же можно выбрать метод "Четыре золотых сигнала", метрик будут аналогичным как для сервиса API выше

**Задержка**
  - Response time (latency) for MES API - время ответов от АПИ

**Трафик**
  - Number of requests (RPS) for internet MES API - метрик о кол-ве запросов это база, котора говорит о нагрузке
  - Number of requests (RPS) per user for internet MES API - меткрика кол-ва запросов на каждого юзера, нам может понадобиться для выявлении аномалий, каких-то выбрасов, так же для понимания небходимости кэширования, если мы увидим множетво однотипных запросов
  - Kb tranferred (received) for MES API - показывает трафик между клиентом и системой
  - Kb provided (sent)

**Ошибки**
 - Number of HTTP 200 for MES API - тут можно настроить чтобы система мониторила ответы с 200, но с неправильными ответами/неверным контентом (проверяем неявные ошибки)
 - Number of HTTP 500 for MES API - кол-во внутренних ошибок сервера

**Насыщенность**
  - CPU % for MES API - утилизация CPU для сервиса
  - Memory Utilisation for MES API - утилизация по памяти для сервиса

### CRM API
Для это части так же можно выбрать метод "Четыре золотых сигнала", метрик будут аналогичным как для сервиса API выше

**Задержка**
  - Response time (latency) for CRM API - время ответов от АПИ

**Трафик**
  - Number of requests (RPS) for internet CRM API - метрик о кол-ве запросов это база, котора говорит о нагрузке
  - Number of requests (RPS) per user for internet CRM API - меткрика кол-ва запросов на каждого юзера, нам может понадобиться для выявлении аномалий, каких-то выбрасов, так же для понимания небходимости кэширования, если мы увидим множетво однотипных запросов
  - Kb tranferred (received) for CRM API - показывает трафик между клиентом и системой
  - Kb provided (sent)

**Ошибки**
 - Number of HTTP 200 for CRM API - тут можно настроить чтобы система мониторила ответы с 200, но с неправильными ответами/неверным контентом (проверяем неявные ошибки)
 - Number of HTTP 500 for CRM API - кол-во внутренних ошибок сервера

**Насыщенность**
  - CPU % for CRM API - утилизация CPU для сервиса
  - Memory Utilisation for CRM API - утилизация по памяти для сервиса

### Shop DB / MES DB / S3 DB
Для баз данных больше подойдет метод **USE**, т.к. он фокусируется на ресурсах, а базы данных сильно от них зависят, так же важно вовремя контролировать насыщение (перегрузку), метод и это учитывает

Для каждого аспекта мы добавим соответствующие метрики:

1. Utilization (Использование ресурсов) - Показывает, сколько ресурсов используется и насколько активно база работает.
 - CPU Utilization — загрузка процессора, выполняющего запросы.
 - Memory Utilization — объем RAM памяти, занятой базой данных.
 - Disk I/O Utilization — использование дисковой подсистемы (чтение/запись).
 - Connections Used(Number of connections) — количество активных подключений (из общего лимита).
 - QPS (Queries Per Second) — сколько запросов выполняется в секунду (индикатор нагрузки).
2. Saturation (Насыщение системы) - Показывает, насколько близка база данных к своим пределам.
 - Query Queue Length — количество запросов, ожидающих выполнения.
 - Connection Pool Saturation — использование пула подключений (процент от лимита).
 - Replication Lag — задержка репликации данных между основным сервером и репликами (если у нас появятся реплики)
 - Disk Latency — время, требуемое для операций чтения/записи на диск.
3. Errors (Ошибки) - Показывает, какие проблемы возникают при работе базы данных.
 - Query Error Rate — процент запросов, завершившихся с ошибкой.
 - Failed Connections — количество неудачных попыток подключиться к базе.
 - Timeouts — количество запросов, которые не успели выполниться в заданное время.
 - Replication Errors — количество ошибок в процессе репликации данных.


### Message Queue RabbitMQ
Для мониторинга можно применить метод USE (Utilization, Saturation, Errors), т.к. он хорошо подходит для мониторинга стабильности, и анализа нагрузки.
Заводим метрики:

1. Utilization (Использование ресурсов) - Отражает, как активно используется RabbitMQ и какие ресурсы потребляет:

 - Messages Published per Second — сколько сообщений поступает в систему.
 - Messages Delivered per Second — сколько сообщений обрабатывается потребителями.
 - Queue Depth (Queue Length) — количество сообщений в очереди.
 - Connection Count — количество активных подключений (процессов/сервисов).
 - Node Resource Usage:
   - CPU Usage — загрузка CPU на узле RabbitMQ.
   - Memory Usage — объем используемой оперативной памяти
   - Disk I/O Utilization — операции чтения/записи (важно для персистентных сообщений).
2. Saturation (Насыщение системы) - Показывает, насколько RabbitMQ приближается к своим пределам.

 - Queue Backlog — количество сообщений, ожидающих обработки (если растет, значит, система перегружена).
 - Consumers per Queue — количество потребителей для каждой очереди (показывает, эффективно ли распределяется нагрузка).
 - Memory Alarms — срабатывание сигналов, что память на узле RabbitMQ заканчивается.
 - Disk Alarms — сигнал, что место на диске почти заполнено.

3. Errors (Ошибки) - Отражает проблемы, возникающие при работе RabbitMQ.
 - Unacked Messages — количество сообщений, которые были доставлены, но не подтверждены (может указывать на проблемы с потребителями).
 - Connection Errors — количество ошибок подключения клиентов к RabbitMQ.
 - Dead Lettered Messages — количество сообщений, отправленных в Dead Letter Queue (DLQ).
 - Node Failures — ошибки или сбои в узлах RabbitMQ-кластера.

## План действий

1. Создать инстанс time-series базы данных с использованием Prometheus
2. Для каждого сервиса откуда будем собирать метрики внедрить модуль сбора матрик - Prometheus exporter
3. Реализовать требуемые для каждого сервиса метрики
4. Поднятие и настройка Grafana для визуализации данных
5. Настройка alert'ов для критичных параметров
